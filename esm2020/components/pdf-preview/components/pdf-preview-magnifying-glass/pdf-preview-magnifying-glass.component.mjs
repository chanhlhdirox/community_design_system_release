import { Component, Input } from '@angular/core';
import { fromEvent, merge, Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
export class PdfPreviewMagnifyingGlassComponent {
    constructor(ngZone, renderer) {
        this.ngZone = ngZone;
        this.renderer = renderer;
        this.magnifyingSize = 300;
        this.mouseSensibility = 10;
        this.destroy$ = new Subject();
        this.scale = 1;
        this.nativeWidth = 0;
        this.nativeHeight = 0;
        this.CANVAS_CLASSNAME = 'magnifyingGlass';
        this.CANVAS_CONTAINER_CLASSNAME = 'magnifyContainer';
        this.PDF_CONTAINER_CLASSNAME = 'up-pdf-preview-viewer-container';
    }
    ngOnDestroy() {
        this.destroy$.next();
    }
    createMagnifyingGlass() {
        if (this.canvasContainer || this.canvas) {
            return;
        }
        this.ngZone.runOutsideAngular(() => {
            this.createMagnifyingGlassDOMElement();
            this.bindMagnifyingGlass();
        });
    }
    destroyMagnifyingGlass() {
        if (!this.canvasContainer || !this.canvas) {
            return;
        }
        this.ngZone.runOutsideAngular(() => {
            this.canvasContainer = null;
            this.hoveringPageNumber = null;
            this.canvas = null;
            this.destroy$.next();
            const element = this.parentElement.nativeElement.querySelector(`.${this.PDF_CONTAINER_CLASSNAME} .${this.CANVAS_CONTAINER_CLASSNAME}`) ||
                document.querySelector(`.${this.PDF_CONTAINER_CLASSNAME} .${this.CANVAS_CONTAINER_CLASSNAME}`);
            element.remove();
            if (this.animationFrame) {
                cancelAnimationFrame(this.animationFrame);
            }
        });
    }
    createMagnifyingGlassDOMElement() {
        this.canvas = document.createElement('canvas');
        this.canvas.className = this.CANVAS_CLASSNAME;
        this.canvasContainer = document.createElement('div');
        this.canvasContainer.style.width = `${this.magnifyingSize}px`;
        this.canvasContainer.style.height = `${this.magnifyingSize}px`;
        this.canvasContainer.className = `${this.CANVAS_CONTAINER_CLASSNAME} hidden`;
        this.canvasContainer.appendChild(this.canvas);
        const parentElementContainer = this.parentElement.nativeElement.querySelector(`.${this.PDF_CONTAINER_CLASSNAME}`) ||
            document.querySelector(`.${this.PDF_CONTAINER_CLASSNAME}`);
        parentElementContainer.appendChild(this.canvasContainer);
    }
    calculateCanvasOffset() {
        const pageElement = this.parentElement?.nativeElement?.querySelector(`.${this.PDF_CONTAINER_CLASSNAME} .page`) ||
            document.querySelector(`.${this.PDF_CONTAINER_CLASSNAME} .page`);
        const containerElement = this.parentElement?.nativeElement?.querySelector(`.${this.PDF_CONTAINER_CLASSNAME}`) ||
            document.querySelector(`.${this.PDF_CONTAINER_CLASSNAME}`);
        const pageElementStyle = getComputedStyle(pageElement, null);
        const containerElementStyle = getComputedStyle(containerElement, null);
        this.canvasContainerWidth = parseFloat(pageElementStyle?.width.replace('px', ''));
        this.canvasContainerHeight = parseFloat(pageElementStyle?.height.replace('px', ''));
        this.containerWidth = parseFloat(containerElementStyle?.width.replace('px', ''));
        this.containerHeight = parseFloat(containerElementStyle?.height.replace('px', ''));
        const rect = pageElement?.getBoundingClientRect();
        this.canvasContainerOffset = {
            top: rect.top + (window.scrollY || window.pageYOffset),
            left: rect.left + (window.scrollX || window.pageXOffset)
        };
    }
    renderZoomedPageOnCanvas() {
        this.document.getPage(this.page).then((page) => {
            const zoomedViewPort = this.getZoomedViewPort(page);
            const zoomedRenderContext = {
                canvasContext: this.canvas.getContext('2d'),
                viewport: zoomedViewPort
            };
            page.render(zoomedRenderContext);
        });
    }
    bindMagnifyingGlass() {
        const container = this.parentElement?.nativeElement?.querySelector('.ng2-pdf-viewer-container .pdfViewer') ||
            document.querySelector('.ng2-pdf-viewer-container .pdfViewer');
        const mouseEnter$ = fromEvent(container, 'mouseenter');
        const mouseOver$ = fromEvent(container, 'mouseover');
        const mouseMove$ = fromEvent(container, 'mousemove');
        const magnifyingGlassMouseMove$ = fromEvent(this.canvasContainer, 'mousemove');
        const scroll$ = fromEvent(window, 'scroll');
        merge(mouseEnter$, mouseOver$, mouseMove$, magnifyingGlassMouseMove$, scroll$)
            .pipe(takeUntil(this.destroy$))
            .subscribe((event) => {
            if (this.animationFrame) {
                cancelAnimationFrame(this.animationFrame);
            }
            if (this.hoveringPageNumber !== this.page) {
                this.renderZoomedPageOnCanvas();
            }
            this.hoveringPageNumber = this.page;
            this.animationFrame = requestAnimationFrame(() => {
                this.calculateCanvasOffset();
                if (!event?.pageX && !event?.pageY) {
                    this.animationFrame = null;
                    return this.hideMagnifyingGlass();
                }
                if (this.isMouseOutsidePdfContainer(event)) {
                    this.animationFrame = null;
                    return this.hideMagnifyingGlass();
                }
                this.showMagnifyingGlass(event);
            });
        });
        fromEvent(container, 'mouseout')
            .pipe(takeUntil(this.destroy$))
            .subscribe(() => {
            if (this.animationFrame) {
                cancelAnimationFrame(this.animationFrame);
            }
            this.animationFrame = requestAnimationFrame(() => {
                this.hideMagnifyingGlass();
                this.animationFrame = null;
            });
        });
    }
    isMouseOutsidePdfContainer(event) {
        return (event.pageY <= this.canvasContainerOffset?.top ||
            event.pageY >=
                this.canvasContainerOffset?.top + this.canvasContainerHeight + this.mouseSensibility ||
            event.pageX <= this.canvasContainerOffset?.left - this.mouseSensibility ||
            event.pageX >=
                this.canvasContainerOffset?.left + this.canvasContainerWidth + this.mouseSensibility);
    }
    hideMagnifyingGlass() {
        this.renderer.addClass(this.canvasContainer, 'hidden');
    }
    showMagnifyingGlass(event) {
        const paddingX = (this.containerWidth - this.canvasContainerWidth) / 2;
        const mx = event.pageX - this.canvasContainerOffset.left + paddingX;
        const my = event.pageY - this.canvasContainerOffset.top;
        const container = this.parentElement?.nativeElement?.querySelector(`.${this.PDF_CONTAINER_CLASSNAME}`) ||
            document.querySelector(`.${this.PDF_CONTAINER_CLASSNAME}`);
        this.canvasContainer.style.left = mx - parseInt(this.magnifyingSize.toString(), 10) / 2 + 'px';
        this.canvasContainer.style.top =
            my - parseInt(this.magnifyingSize.toString(), 10) / 2 - container?.scrollTop + 'px';
        this.canvasContainer.style.position = 'absolute';
        const rect = this.canvas.getBoundingClientRect();
        const currentLeft = parseFloat(this.canvas.style.left) || 0;
        const currentTop = parseFloat(this.canvas.style.top) || 0;
        const rx = this.canvasContainerOffset.left - ((mx / this.canvasContainerWidth) * this.nativeWidth) / 2;
        const ry = this.canvasContainerOffset.top - ((my / this.canvasContainerHeight) * this.nativeHeight) / 2;
        this.canvas.style.left = rx - (rect.left + window.pageXOffset) + currentLeft + 'px';
        this.canvas.style.top = ry - (rect.top + window.pageYOffset) + currentTop + 'px';
        this.canvas.style.position = 'relative';
        this.renderer.removeClass(this.canvasContainer, 'hidden');
    }
    getZoomedViewPort(page) {
        const viewport = page.getViewport({ scale: +this.scale * 2 });
        this.nativeWidth = viewport.width;
        this.nativeHeight = viewport.height;
        this.setCanvasDimensions(this.canvas, viewport.width, viewport.height);
        return viewport;
    }
    setCanvasDimensions(canvas, width, height) {
        const ratio = this.backingScale(canvas);
        canvas.width = Math.floor(width * ratio);
        canvas.height = Math.floor(height * ratio);
        canvas.style.width = Math.floor(width) + 'px';
        canvas.style.height = Math.floor(height) + 'px';
        canvas.getContext('2d').setTransform(ratio, 0, 0, ratio, 0, 0);
        return canvas;
    }
    backingScale(canvas) {
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const bsr = ctx.webkitBackingStorePixelRatio ||
            ctx.mozBackingStorePixelRatio ||
            ctx.msBackingStorePixelRatio ||
            ctx.oBackingStorePixelRatio ||
            ctx.backingStorePixelRatio ||
            1;
        return dpr / bsr;
    }
}
PdfPreviewMagnifyingGlassComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: PdfPreviewMagnifyingGlassComponent, deps: [{ token: i0.NgZone }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Component });
PdfPreviewMagnifyingGlassComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.3.0", type: PdfPreviewMagnifyingGlassComponent, selector: "up-pdf-preview-magnifying-glass", inputs: { parentElement: "parentElement", document: "document", page: "page", magnifyingSize: "magnifyingSize", mouseSensibility: "mouseSensibility" }, ngImport: i0, template: '', isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: PdfPreviewMagnifyingGlassComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'up-pdf-preview-magnifying-glass',
                    template: ''
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: i0.Renderer2 }]; }, propDecorators: { parentElement: [{
                type: Input
            }], document: [{
                type: Input
            }], page: [{
                type: Input
            }], magnifyingSize: [{
                type: Input
            }], mouseSensibility: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGRmLXByZXZpZXctbWFnbmlmeWluZy1nbGFzcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91cC9jb21wb25lbnRzL3BkZi1wcmV2aWV3L2NvbXBvbmVudHMvcGRmLXByZXZpZXctbWFnbmlmeWluZy1nbGFzcy9wZGYtcHJldmlldy1tYWduaWZ5aW5nLWdsYXNzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFjLEtBQUssRUFBZ0MsTUFBTSxlQUFlLENBQUM7QUFFM0YsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFNM0MsTUFBTSxPQUFPLGtDQUFrQztJQTZCN0MsWUFBb0IsTUFBYyxFQUFVLFFBQW1CO1FBQTNDLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBekJ0RCxtQkFBYyxHQUFvQixHQUFHLENBQUM7UUFDdEMscUJBQWdCLEdBQUcsRUFBRSxDQUFDO1FBRXZCLGFBQVEsR0FBa0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQVF4QyxVQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ1YsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFDaEIsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFRakIscUJBQWdCLEdBQUcsaUJBQWlCLENBQUM7UUFDckMsK0JBQTBCLEdBQUcsa0JBQWtCLENBQUM7UUFDaEQsNEJBQXVCLEdBQUcsaUNBQWlDLENBQUM7SUFFRixDQUFDO0lBRW5FLFdBQVc7UUFDVCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxxQkFBcUI7UUFDbkIsSUFBSSxJQUFJLENBQUMsZUFBZSxJQUFJLElBQUksQ0FB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QkFDRyxnQkFBZ0I7c0JBQXhCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIElucHV0LCBOZ1pvbmUsIE9uRGVzdHJveSwgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQREZEb2N1bWVudFByb3h5LCBQREZQYWdlUHJveHkgfSBmcm9tICduZzItcGRmLXZpZXdlcic7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIG1lcmdlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3VwLXBkZi1wcmV2aWV3LW1hZ25pZnlpbmctZ2xhc3MnLFxuICB0ZW1wbGF0ZTogJydcbn0pXG5leHBvcnQgY2xhc3MgUGRmUHJldmlld01hZ25pZnlpbmdHbGFzc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpIHBhcmVudEVsZW1lbnQ6IEVsZW1lbnRSZWY7XG4gIEBJbnB1dCgpIGRvY3VtZW50OiBQREZEb2N1bWVudFByb3h5O1xuICBASW5wdXQoKSBwYWdlOiBudW1iZXI7XG4gIEBJbnB1dCgpIG1hZ25pZnlpbmdTaXplOiBzdHJpbmcgfCBudW1iZXIgPSAzMDA7XG4gIEBJbnB1dCgpIG1vdXNlU2Vuc2liaWxpdHkgPSAxMDtcblxuICBwcml2YXRlIGRlc3Ryb3kkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcblxuICBwcml2YXRlIGFuaW1hdGlvbkZyYW1lOiBudW1iZXI7XG4gIHByaXZhdGUgY2FudmFzQ29udGFpbmVyT2Zmc2V0OiB7IGxlZnQ/OiBudW1iZXI7IHJpZ2h0PzogbnVtYmVyOyB0b3A/OiBudW1iZXI7IGJvdHRvbT86IG51bWJlciB9O1xuICBwcml2YXRlIGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQ7XG4gIHByaXZhdGUgY2FudmFzQ29udGFpbmVyOiBIVE1MRWxlbWVudDtcblxuICBwcml2YXRlIGhvdmVyaW5nUGFnZU51bWJlcjtcbiAgcHJpdmF0ZSBzY2FsZSA9IDE7XG4gIHByaXZhdGUgbmF0aXZlV2lkdGggPSAwO1xuICBwcml2YXRlIG5hdGl2ZUhlaWdodCA9IDA7XG5cbiAgcHJpdmF0ZSBjYW52YXNDb250YWluZXJXaWR0aDogbnVtYmVyO1xuICBwcml2YXRlIGNhbnZhc0NvbnRhaW5lckhlaWdodDogbnVtYmVyO1xuXG4gIHByaXZhdGUgY29udGFpbmVyV2lkdGg6IG51bWJlcjtcbiAgcHJpdmF0ZSBjb250YWluZXJIZWlnaHQ6IG51bWJlcjtcblxuICBwcml2YXRlIENBTlZBU19DTEFTU05BTUUgPSAnbWFnbmlmeWluZ0dsYXNzJztcbiAgcHJpdmF0ZSBDQU5WQVNfQ09OVEFJTkVSX0NMQVNTTkFNRSA9ICdtYWduaWZ5Q29udGFpbmVyJztcbiAgcHJpdmF0ZSBQREZfQ09OVEFJTkVSX0NMQVNTTkFNRSA9ICd1cC1wZGYtcHJldmlldy12aWV3ZXItY29udGFpbmVyJztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nWm9uZTogTmdab25lLCBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIpIHt9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gIH1cblxuICBjcmVhdGVNYWduaWZ5aW5nR2xhc3MoKSB7XG4gICAgaWYgKHRoaXMuY2FudmFzQ29udGFpbmVyIHx8IHRoaXMuY2FudmFzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGhpcy5jcmVhdGVNYWduaWZ5aW5nR2xhc3NET01FbGVtZW50KCk7XG4gICAgICB0aGlzLmJpbmRNYWduaWZ5aW5nR2xhc3MoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRlc3Ryb3lNYWduaWZ5aW5nR2xhc3MoKSB7XG4gICAgaWYgKCF0aGlzLmNhbnZhc0NvbnRhaW5lciB8fCAhdGhpcy5jYW52YXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICB0aGlzLmNhbnZhc0NvbnRhaW5lciA9IG51bGw7XG4gICAgICB0aGlzLmhvdmVyaW5nUGFnZU51bWJlciA9IG51bGw7XG4gICAgICB0aGlzLmNhbnZhcyA9IG51bGw7XG4gICAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcblxuICAgICAgY29uc3QgZWxlbWVudCA9XG4gICAgICAgIHRoaXMucGFyZW50RWxlbWVudC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoXG4gICAgICAgICAgYC4ke3RoaXMuUERGX0NPTlRBSU5FUl9DTEFTU05BTUV9IC4ke3RoaXMuQ0FOVkFTX0NPTlRBSU5FUl9DTEFTU05BTUV9YFxuICAgICAgICApIHx8XG4gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXG4gICAgICAgICAgYC4ke3RoaXMuUERGX0NPTlRBSU5FUl9DTEFTU05BTUV9IC4ke3RoaXMuQ0FOVkFTX0NPTlRBSU5FUl9DTEFTU05BTUV9YFxuICAgICAgICApO1xuXG4gICAgICBlbGVtZW50LnJlbW92ZSgpO1xuXG4gICAgICBpZiAodGhpcy5hbmltYXRpb25GcmFtZSkge1xuICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLmFuaW1hdGlvbkZyYW1lKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWFnbmlmeWluZ0dsYXNzRE9NRWxlbWVudCgpIHtcbiAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIHRoaXMuY2FudmFzLmNsYXNzTmFtZSA9IHRoaXMuQ0FOVkFTX0NMQVNTTkFNRTtcblxuICAgIHRoaXMuY2FudmFzQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgdGhpcy5jYW52YXNDb250YWluZXIuc3R5bGUud2lkdGggPSBgJHt0aGlzLm1hZ25pZnlpbmdTaXplfXB4YDtcbiAgICB0aGlzLmNhbnZhc0NvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSBgJHt0aGlzLm1hZ25pZnlpbmdTaXplfXB4YDtcbiAgICB0aGlzLmNhbnZhc0NvbnRhaW5lci5jbGFzc05hbWUgPSBgJHt0aGlzLkNBTlZBU19DT05UQUlORVJfQ0xBU1NOQU1FfSBoaWRkZW5gO1xuXG4gICAgdGhpcy5jYW52YXNDb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpO1xuXG4gICAgY29uc3QgcGFyZW50RWxlbWVudENvbnRhaW5lciA9XG4gICAgICB0aGlzLnBhcmVudEVsZW1lbnQubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKGAuJHt0aGlzLlBERl9DT05UQUlORVJfQ0xBU1NOQU1FfWApIHx8XG4gICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAuJHt0aGlzLlBERl9DT05UQUlORVJfQ0xBU1NOQU1FfWApO1xuICAgIHBhcmVudEVsZW1lbnRDb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXNDb250YWluZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVDYW52YXNPZmZzZXQoKSB7XG4gICAgY29uc3QgcGFnZUVsZW1lbnQgPVxuICAgICAgdGhpcy5wYXJlbnRFbGVtZW50Py5uYXRpdmVFbGVtZW50Py5xdWVyeVNlbGVjdG9yKGAuJHt0aGlzLlBERl9DT05UQUlORVJfQ0xBU1NOQU1FfSAucGFnZWApIHx8XG4gICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAuJHt0aGlzLlBERl9DT05UQUlORVJfQ0xBU1NOQU1FfSAucGFnZWApO1xuXG4gICAgY29uc3QgY29udGFpbmVyRWxlbWVudCA9XG4gICAgICB0aGlzLnBhcmVudEVsZW1lbnQ/Lm5hdGl2ZUVsZW1lbnQ/LnF1ZXJ5U2VsZWN0b3IoYC4ke3RoaXMuUERGX0NPTlRBSU5FUl9DTEFTU05BTUV9YCkgfHxcbiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC4ke3RoaXMuUERGX0NPTlRBSU5FUl9DTEFTU05BTUV9YCk7XG5cbiAgICBjb25zdCBwYWdlRWxlbWVudFN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZShwYWdlRWxlbWVudCwgbnVsbCk7XG4gICAgY29uc3QgY29udGFpbmVyRWxlbWVudFN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZShjb250YWluZXJFbGVtZW50LCBudWxsKTtcblxuICAgIHRoaXMuY2FudmFzQ29udGFpbmVyV2lkdGggPSBwYXJzZUZsb2F0KHBhZ2VFbGVtZW50U3R5bGU/LndpZHRoLnJlcGxhY2UoJ3B4JywgJycpKTtcbiAgICB0aGlzLmNhbnZhc0NvbnRhaW5lckhlaWdodCA9IHBhcnNlRmxvYXQocGFnZUVsZW1lbnRTdHlsZT8uaGVpZ2h0LnJlcGxhY2UoJ3B4JywgJycpKTtcblxuICAgIHRoaXMuY29udGFpbmVyV2lkdGggPSBwYXJzZUZsb2F0KGNvbnRhaW5lckVsZW1lbnRTdHlsZT8ud2lkdGgucmVwbGFjZSgncHgnLCAnJykpO1xuICAgIHRoaXMuY29udGFpbmVySGVpZ2h0ID0gcGFyc2VGbG9hdChjb250YWluZXJFbGVtZW50U3R5bGU/LmhlaWdodC5yZXBsYWNlKCdweCcsICcnKSk7XG5cbiAgICBjb25zdCByZWN0ID0gcGFnZUVsZW1lbnQ/LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIHRoaXMuY2FudmFzQ29udGFpbmVyT2Zmc2V0ID0ge1xuICAgICAgdG9wOiByZWN0LnRvcCArICh3aW5kb3cuc2Nyb2xsWSB8fCB3aW5kb3cucGFnZVlPZmZzZXQpLFxuICAgICAgbGVmdDogcmVjdC5sZWZ0ICsgKHdpbmRvdy5zY3JvbGxYIHx8IHdpbmRvdy5wYWdlWE9mZnNldClcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSByZW5kZXJab29tZWRQYWdlT25DYW52YXMoKSB7XG4gICAgdGhpcy5kb2N1bWVudC5nZXRQYWdlKHRoaXMucGFnZSkudGhlbigocGFnZSkgPT4ge1xuICAgICAgY29uc3Qgem9vbWVkVmlld1BvcnQgPSB0aGlzLmdldFpvb21lZFZpZXdQb3J0KHBhZ2UpO1xuICAgICAgY29uc3Qgem9vbWVkUmVuZGVyQ29udGV4dCA9IHtcbiAgICAgICAgY2FudmFzQ29udGV4dDogdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKSxcbiAgICAgICAgdmlld3BvcnQ6IHpvb21lZFZpZXdQb3J0XG4gICAgICB9O1xuICAgICAgcGFnZS5yZW5kZXIoem9vbWVkUmVuZGVyQ29udGV4dCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGJpbmRNYWduaWZ5aW5nR2xhc3MoKSB7XG4gICAgY29uc3QgY29udGFpbmVyID1cbiAgICAgIHRoaXMucGFyZW50RWxlbWVudD8ubmF0aXZlRWxlbWVudD8ucXVlcnlTZWxlY3RvcignLm5nMi1wZGYtdmlld2VyLWNvbnRhaW5lciAucGRmVmlld2VyJykgfHxcbiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5uZzItcGRmLXZpZXdlci1jb250YWluZXIgLnBkZlZpZXdlcicpO1xuICAgIGNvbnN0IG1vdXNlRW50ZXIkID0gZnJvbUV2ZW50KGNvbnRhaW5lciwgJ21vdXNlZW50ZXInKTtcbiAgICBjb25zdCBtb3VzZU92ZXIkID0gZnJvbUV2ZW50KGNvbnRhaW5lciwgJ21vdXNlb3ZlcicpO1xuICAgIGNvbnN0IG1vdXNlTW92ZSQgPSBmcm9tRXZlbnQoY29udGFpbmVyLCAnbW91c2Vtb3ZlJyk7XG4gICAgY29uc3QgbWFnbmlmeWluZ0dsYXNzTW91c2VNb3ZlJCA9IGZyb21FdmVudCh0aGlzLmNhbnZhc0NvbnRhaW5lciwgJ21vdXNlbW92ZScpO1xuICAgIGNvbnN0IHNjcm9sbCQgPSBmcm9tRXZlbnQod2luZG93LCAnc2Nyb2xsJyk7XG5cbiAgICBtZXJnZShtb3VzZUVudGVyJCwgbW91c2VPdmVyJCwgbW91c2VNb3ZlJCwgbWFnbmlmeWluZ0dsYXNzTW91c2VNb3ZlJCwgc2Nyb2xsJClcbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcbiAgICAgIC5zdWJzY3JpYmUoKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmFuaW1hdGlvbkZyYW1lKSB7XG4gICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5hbmltYXRpb25GcmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5ob3ZlcmluZ1BhZ2VOdW1iZXIgIT09IHRoaXMucGFnZSkge1xuICAgICAgICAgIHRoaXMucmVuZGVyWm9vbWVkUGFnZU9uQ2FudmFzKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmhvdmVyaW5nUGFnZU51bWJlciA9IHRoaXMucGFnZTtcbiAgICAgICAgdGhpcy5hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jYWxjdWxhdGVDYW52YXNPZmZzZXQoKTtcblxuICAgICAgICAgIGlmICghZXZlbnQ/LnBhZ2VYICYmICFldmVudD8ucGFnZVkpIHtcbiAgICAgICAgICAgIHRoaXMuYW5pbWF0aW9uRnJhbWUgPSBudWxsO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGlkZU1hZ25pZnlpbmdHbGFzcygpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmICh0aGlzLmlzTW91c2VPdXRzaWRlUGRmQ29udGFpbmVyKGV2ZW50KSkge1xuICAgICAgICAgICAgdGhpcy5hbmltYXRpb25GcmFtZSA9IG51bGw7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5oaWRlTWFnbmlmeWluZ0dsYXNzKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuc2hvd01hZ25pZnlpbmdHbGFzcyhldmVudCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICBmcm9tRXZlbnQoY29udGFpbmVyLCAnbW91c2VvdXQnKVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmFuaW1hdGlvbkZyYW1lKSB7XG4gICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5hbmltYXRpb25GcmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFuaW1hdGlvbkZyYW1lID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICB0aGlzLmhpZGVNYWduaWZ5aW5nR2xhc3MoKTtcbiAgICAgICAgICB0aGlzLmFuaW1hdGlvbkZyYW1lID0gbnVsbDtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaXNNb3VzZU91dHNpZGVQZGZDb250YWluZXIoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICByZXR1cm4gKFxuICAgICAgZXZlbnQucGFnZVkgPD0gdGhpcy5jYW52YXNDb250YWluZXJPZmZzZXQ/LnRvcCB8fFxuICAgICAgZXZlbnQucGFnZVkgPj1cbiAgICAgICAgdGhpcy5jYW52YXNDb250YWluZXJPZmZzZXQ/LnRvcCArIHRoaXMuY2FudmFzQ29udGFpbmVySGVpZ2h0ICsgdGhpcy5tb3VzZVNlbnNpYmlsaXR5IHx8XG4gICAgICBldmVudC5wYWdlWCA8PSB0aGlzLmNhbnZhc0NvbnRhaW5lck9mZnNldD8ubGVmdCAtIHRoaXMubW91c2VTZW5zaWJpbGl0eSB8fFxuICAgICAgZXZlbnQucGFnZVggPj1cbiAgICAgICAgdGhpcy5jYW52YXNDb250YWluZXJPZmZzZXQ/LmxlZnQgKyB0aGlzLmNhbnZhc0NvbnRhaW5lcldpZHRoICsgdGhpcy5tb3VzZVNlbnNpYmlsaXR5XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgaGlkZU1hZ25pZnlpbmdHbGFzcygpIHtcbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuY2FudmFzQ29udGFpbmVyLCAnaGlkZGVuJyk7XG4gIH1cblxuICBwcml2YXRlIHNob3dNYWduaWZ5aW5nR2xhc3MoZXZlbnQpIHtcbiAgICBjb25zdCBwYWRkaW5nWCA9ICh0aGlzLmNvbnRhaW5lcldpZHRoIC0gdGhpcy5jYW52YXNDb250YWluZXJXaWR0aCkgLyAyO1xuXG4gICAgY29uc3QgbXggPSBldmVudC5wYWdlWCAtIHRoaXMuY2FudmFzQ29udGFpbmVyT2Zmc2V0LmxlZnQgKyBwYWRkaW5nWDtcbiAgICBjb25zdCBteSA9IGV2ZW50LnBhZ2VZIC0gdGhpcy5jYW52YXNDb250YWluZXJPZmZzZXQudG9wO1xuXG4gICAgY29uc3QgY29udGFpbmVyID1cbiAgICAgIHRoaXMucGFyZW50RWxlbWVudD8ubmF0aXZlRWxlbWVudD8ucXVlcnlTZWxlY3RvcihgLiR7dGhpcy5QREZfQ09OVEFJTkVSX0NMQVNTTkFNRX1gKSB8fFxuICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLiR7dGhpcy5QREZfQ09OVEFJTkVSX0NMQVNTTkFNRX1gKTtcblxuICAgIHRoaXMuY2FudmFzQ29udGFpbmVyLnN0eWxlLmxlZnQgPSBteCAtIHBhcnNlSW50KHRoaXMubWFnbmlmeWluZ1NpemUudG9TdHJpbmcoKSwgMTApIC8gMiArICdweCc7XG4gICAgdGhpcy5jYW52YXNDb250YWluZXIuc3R5bGUudG9wID1cbiAgICAgIG15IC0gcGFyc2VJbnQodGhpcy5tYWduaWZ5aW5nU2l6ZS50b1N0cmluZygpLCAxMCkgLyAyIC0gY29udGFpbmVyPy5zY3JvbGxUb3AgKyAncHgnO1xuICAgIHRoaXMuY2FudmFzQ29udGFpbmVyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcblxuICAgIGNvbnN0IHJlY3QgPSB0aGlzLmNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBjdXJyZW50TGVmdCA9IHBhcnNlRmxvYXQodGhpcy5jYW52YXMuc3R5bGUubGVmdCkgfHwgMDtcbiAgICBjb25zdCBjdXJyZW50VG9wID0gcGFyc2VGbG9hdCh0aGlzLmNhbnZhcy5zdHlsZS50b3ApIHx8IDA7XG5cbiAgICBjb25zdCByeCA9XG4gICAgICB0aGlzLmNhbnZhc0NvbnRhaW5lck9mZnNldC5sZWZ0IC0gKChteCAvIHRoaXMuY2FudmFzQ29udGFpbmVyV2lkdGgpICogdGhpcy5uYXRpdmVXaWR0aCkgLyAyO1xuICAgIGNvbnN0IHJ5ID1cbiAgICAgIHRoaXMuY2FudmFzQ29udGFpbmVyT2Zmc2V0LnRvcCAtICgobXkgLyB0aGlzLmNhbnZhc0NvbnRhaW5lckhlaWdodCkgKiB0aGlzLm5hdGl2ZUhlaWdodCkgLyAyO1xuXG4gICAgdGhpcy5jYW52YXMuc3R5bGUubGVmdCA9IHJ4IC0gKHJlY3QubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCkgKyBjdXJyZW50TGVmdCArICdweCc7XG4gICAgdGhpcy5jYW52YXMuc3R5bGUudG9wID0gcnkgLSAocmVjdC50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQpICsgY3VycmVudFRvcCArICdweCc7XG4gICAgdGhpcy5jYW52YXMuc3R5bGUucG9zaXRpb24gPSAncmVsYXRpdmUnO1xuICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5jYW52YXNDb250YWluZXIsICdoaWRkZW4nKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Wm9vbWVkVmlld1BvcnQocGFnZTogUERGUGFnZVByb3h5KSB7XG4gICAgY29uc3Qgdmlld3BvcnQgPSBwYWdlLmdldFZpZXdwb3J0KHsgc2NhbGU6ICt0aGlzLnNjYWxlICogMiB9KTtcbiAgICB0aGlzLm5hdGl2ZVdpZHRoID0gdmlld3BvcnQud2lkdGg7XG4gICAgdGhpcy5uYXRpdmVIZWlnaHQgPSB2aWV3cG9ydC5oZWlnaHQ7XG4gICAgdGhpcy5zZXRDYW52YXNEaW1lbnNpb25zKHRoaXMuY2FudmFzLCB2aWV3cG9ydC53aWR0aCwgdmlld3BvcnQuaGVpZ2h0KTtcbiAgICByZXR1cm4gdmlld3BvcnQ7XG4gIH1cblxuICBwcml2YXRlIHNldENhbnZhc0RpbWVuc2lvbnMoY2FudmFzOiBhbnksIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgY29uc3QgcmF0aW8gPSB0aGlzLmJhY2tpbmdTY2FsZShjYW52YXMpO1xuICAgIGNhbnZhcy53aWR0aCA9IE1hdGguZmxvb3Iod2lkdGggKiByYXRpbyk7XG4gICAgY2FudmFzLmhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0ICogcmF0aW8pO1xuICAgIGNhbnZhcy5zdHlsZS53aWR0aCA9IE1hdGguZmxvb3Iod2lkdGgpICsgJ3B4JztcbiAgICBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gTWF0aC5mbG9vcihoZWlnaHQpICsgJ3B4JztcbiAgICBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKS5zZXRUcmFuc2Zvcm0ocmF0aW8sIDAsIDAsIHJhdGlvLCAwLCAwKTtcbiAgICByZXR1cm4gY2FudmFzO1xuICB9XG5cbiAgcHJpdmF0ZSBiYWNraW5nU2NhbGUoY2FudmFzOiBhbnkpIHtcbiAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICBjb25zdCBkcHIgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxO1xuICAgIGNvbnN0IGJzciA9XG4gICAgICBjdHgud2Via2l0QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fFxuICAgICAgY3R4Lm1vekJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHxcbiAgICAgIGN0eC5tc0JhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHxcbiAgICAgIGN0eC5vQmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fFxuICAgICAgY3R4LmJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHxcbiAgICAgIDE7XG4gICAgcmV0dXJuIGRwciAvIGJzcjtcbiAgfVxufVxuIl19